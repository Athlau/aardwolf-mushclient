<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Saturday, November 19, 2022, 3:08 PM -->
<!-- MuClient version 5.07-pre -->

<!-- Plugin "Desa" generated by Plugin Wizard -->

<muclient>
<plugin
   name="Desa"
   author="Athlau"
   id="837faf063e6f5fde9733e26f"
   language="Lua"
   purpose="Autocast desolation without stacking"
   save_state="y"
   date_written="2022-11-19 15:06:56"
   requires="5.07"
   version="1.0"
   >
</plugin>


<!--  Triggers  -->

<triggers>
  <trigger
   enabled="y"
   group="desolation"
   keep_evaluating="y"
   match="^(?:\*)?(?:\[(\d+)\] )?Your anguish does .*$"
   regexp="y"
   sequence="5"
   script="Desa_process_damage"
   send_to="12"

  >
  </trigger>
  <trigger
   enabled="y"
   group="desolation"
   match="^You don't have enough mana to cast 'desolation'\.$"
   regexp="y"
   send_to="12"
   sequence="100"
   script="Desa_decrease"
  >
  </trigger>
  <trigger
   enabled="y"
   group="desolation"
   match="^You are stunned!$"
   regexp="y"
   send_to="12"
   sequence="100"
   script="Desa_decrease"
  >
  </trigger>
  <trigger
   enabled="y"
   group="desolation"
   match="^They aren't here\.$"
   regexp="y"
   send_to="12"
   sequence="100"
   script="Desa_decrease"
  >
  </trigger>
  <trigger
   enabled="y"
   group="desolation"
   match="^Cast desolation on whom\?$"
   regexp="y"
   send_to="12"
   sequence="100"
   script="Desa_decrease"
  >
  </trigger>
  <trigger
   enabled="y"
   group="desolation"
   match="^(Fighting: )?\d+/\d+hp \d+/\d+mana"
   regexp="y"
   send_to="12"
   sequence="100"
   script="Desa_prompt"
  >
  </trigger>
  <trigger
    enabled="y"
    group="desolation"
    match="^\[ Exits"
    omit_from_output="n"
    keep_evaluating="y"
    regexp="y"
    script="Desa_clear"
    send_to="12"
    sequence="2"
  >
  </trigger>

</triggers>

<!--  Aliases  -->

<aliases>
  <alias
   match="^des( .*)?$"
   enabled="y"
   regexp="y"
   send_to="12"
   sequence="100"
   script="Desa_cast"
  >
  </alias>
  <alias
   match="^desc$"
   enabled="y"
   regexp="y"
   send_to="12"
   sequence="100"
   script="Desa_clear"
  >
  </alias>
</aliases>

<script>
<![CDATA[
local desolation_ignore_untill_prompt = false
local desolation_stack_size = 0

function Desa_prompt()
  desolation_ignore_untill_prompt = false
end

function Desa_process_damage()
  if desolation_ignore_untill_prompt then
    --Note("ignoring")
  else
    local stack = AddDesolationStack(-1)
    if stack == 0 then
      Execute("des")
    end
    desolation_ignore_untill_prompt = true
  end
end

function Desa_decrease()
  AddDesolationStack(-1)
end

function Desa_clear(name, line, wildcards)
  AddDesolationStack(-desolation_stack_size)
end

function Desa_cast(name, line, wildcards)
  local target = wildcards[1] or ""
  Send("c 'desolation' "..target)
  AddDesolationStack(1)
  Note("stack "..tostring(desolation_stack_size))
end

function AddDesolationStack(value)
  desolation_stack_size = math.max(0, desolation_stack_size + value)
  --Note("stack "..tostring(desolation_stack_size))
  return desolation_stack_size
end

]]>
</script>


</muclient>
