<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Saturday, November 19, 2022, 3:08 PM -->
<!-- MuClient version 5.07-pre -->

<!-- Plugin "Desa" generated by Plugin Wizard -->

<muclient>
<plugin
   name="Desa"
   author="Athlau"
   id="837faf063e6f5fde9733e26f"
   language="Lua"
   purpose="Autocast some attack spells without stacking"
   save_state="y"
   date_written="2022-11-19 15:06:56"
   requires="5.07"
   version="1.001"
   >
</plugin>


<!--  Triggers  -->

<triggers>
  <trigger
   enabled="y"
   group="desolation"
   keep_evaluating="y"
   match="^(?:\*)?\[\d+\] Your (?<spell>anguish|blast of fury|bone-crunching force|neural overload|projected force|traumatic sending|shroud of flame) .*$"
   regexp="y"
   sequence="150"
   script="Desa_process_damage"
   send_to="12"

  >
  </trigger>
  <trigger
   enabled="y"
   group="desolation"
   match="^You don't have enough mana to cast '(?<spell>desolation|psychosis|spasm|neural overload|projected force|traumatic sending|immolate)'\.$"
   regexp="y"
   send_to="12"
   sequence="100"
   script="Desa_decrease"
  >
  </trigger>
  <trigger
   enabled="y"
   group="desolation"
   match="^You are stunned!$"
   regexp="y"
   send_to="12"
   sequence="100"
   script="Desa_decrease"
  >
  </trigger>
  <trigger
   enabled="y"
   group="desolation"
   match="^They aren't here\.$"
   regexp="y"
   send_to="12"
   sequence="100"
   script="Desa_decrease"
  >
  </trigger>
  <trigger
   enabled="y"
   group="desolation"
   match="^Cast (?<spell>desolation|psychosis|spasm|neural overload|project force|trauma|immolate) on whom\?$"
   regexp="y"
   send_to="12"
   sequence="100"
   script="Desa_decrease"
  >
  </trigger>
  <trigger
   enabled="y"
   group="desolation"
   match="^(Fighting: )?\d+/\d+hp \d+/\d+mana"
   regexp="y"
   send_to="12"
   sequence="100"
   script="Desa_prompt"
  >
  </trigger>
  <trigger
    enabled="y"
    group="desolation"
    match="^\[ Exits"
    omit_from_output="n"
    keep_evaluating="y"
    regexp="y"
    script="Desa_clear"
    send_to="12"
    sequence="2"
  >
  </trigger>

</triggers>

<!--  Aliases  -->

<aliases>
  <alias
   match="^des( .*)?$"
   enabled="y"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>Desa_cast("%1", "desolation")</send>
  </alias>

  <alias
   match="^ps( .*)?$"
   enabled="y"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>Desa_cast("%1", "psychosis")</send>
  </alias>

  <alias
   match="^spasm( .*)?$"
   enabled="y"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>Desa_cast("%1", "spasm")</send>
  </alias>

  <alias
   match="^no( .*)?$"
   enabled="y"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>Desa_cast("%1", "neural overload")</send>
  </alias>

  <alias
   match="^pf( .*)?$"
   enabled="y"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>Desa_cast("%1", "project force")</send>
  </alias>

  <alias
   match="^tr( .*)?$"
   enabled="y"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>Desa_cast("%1", "trauma")</send>
  </alias>

  <alias
   match="^immo( .*)?$"
   enabled="y"
   regexp="y"
   send_to="12"
   sequence="100"
  >
  <send>Desa_cast("%1", "immolate")</send>
  </alias>

  <alias
   match="^desc$"
   enabled="y"
   regexp="y"
   send_to="12"
   sequence="100"
   script="Desa_clear"
  >
  </alias>
</aliases>

<script>
<![CDATA[
require "wait"

local desolation_ignore_untill_prompt = false
local desolation_stack_size = 0

damage_to_command = {
  ["anguish"] = "des",
  ["blast of fury"] = "ps",
  ["bone-crunching force"] = "spasm",
  ["neural overload"] = "no",
  ["projected force"] = "pf",
  ["traumatic sending"] = "tr",
  ["shroud of flame"] = "immo",
}

function Desa_cast(target, spell)
    Send("cast " .. "'" .. spell .. "' " ..target)
    AddDesolationStack(1)
    Note("stack "..tostring(desolation_stack_size))
end

function Desa_prompt()
  desolation_ignore_untill_prompt = false
end

function Desa_process_damage(name, line, wildcards)
  Note("trig")
  wait.make(function()
    wait.time(0.01)
    if desolation_ignore_untill_prompt then
      --Note("ignoring")
      --Note("stack "..tostring(desolation_stack_size))
    else
      local stack = AddDesolationStack(-1)
      if stack == 0 then
        Execute(damage_to_command[wildcards.spell])
      end
      desolation_ignore_untill_prompt = true
    end
  end)
end

function Desa_decrease()
    AddDesolationStack(-1)
end

function Desa_clear(name, line, wildcards)
  AddDesolationStack(-desolation_stack_size)
end

function AddDesolationStack(value)
  desolation_stack_size = math.max(0, desolation_stack_size + value)
  return desolation_stack_size
end

]]>
</script>


</muclient>
