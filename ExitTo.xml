<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Sunday, December 11, 2022, 3:00 PM -->
<!-- MuClient version 5.07-pre -->

<!-- Plugin "ExitTo" generated by Plugin Wizard -->

<muclient>
<plugin
   name="ExitTo"
   author="Athlau"
   id="ae9b72efd384e7152cf77d7d"
   language="Lua"
   purpose="go to a room by exit name or solve mazes"
   save_state="y"
   date_written="2022-12-11 14:58:25"
   requires="5.07"
   version="1.0"
   >

</plugin>


<!--  Triggers  -->

<triggers>
  <trigger
   enabled="y"
   expand_variables="y"
   match="^\s+(?<dir>South|North|East|West|Up|Down)\s+: (?<name>.*)\s*$"
   regexp="y"
   send_to="12"
   sequence="100"
   script="CheckExitsLine"
  >
  </trigger>
  <trigger
   enabled="n"
   expand_variables="y"
   match="^\{mazeto_moved\}$"
   regexp="y"
   send_to="12"
   sequence="100"
   script="MazeToMoved"
   omit_from_output="y"
   omit_from_log="y"
   group="mazeto"
  >
  </trigger>
</triggers>

<!--  Aliases  -->

<aliases>
  <alias
   match="exit_to *"
   enabled="y"
   expand_variables="y"
   send_to="12"
   sequence="100"
   script="ExitTo"
  >
  </alias>
  <alias
   match="maze_to *"
   enabled="y"
   expand_variables="y"
   send_to="12"
   sequence="100"
   script="MazeTo"
  >
  </alias>
  <alias
   match="maze_to_noresume_once"
   enabled="y"
   expand_variables="y"
   send_to="12"
   sequence="100"
   script="MazeToNoResumeOnce"
  >
  </alias>
</aliases>

<!--  Variables  -->

<variables>
  <variable name="target_exit">!!!DONE!!!</variable>
  <variable name="target_maze_room">!!!DONE!!!</variable>
</variables>

<!--  Script  -->


<script>
<![CDATA[
require "gmcphelper"

local target_exit = ""
local last_room = -1
local target_maze_room = ""
local solving_maze = false
local timeout = 30
local start_time = 0
local maze_to_no_resume_once = false

help_message = [[
   In [19648] The Skullgore Plain, mapper cexit wait(0.5);;maze_to 19652;;wait(30)
   In [19652] The Skullgore Plain, mapper cexit exit_to The Dark Path;;wait(0.1)
   Note: before adding cexit in mapper, use maze_to_noresume_once so that it doesn't
         auto resume when hitting target room
]]

function MazeToNoResumeOnce(name, line, wildcards)
  Note("not going to auto resume mapper goto command once")
  maze_to_no_resume_once = true
end

function ExitTo(name, line, wildcards)
  target_exit  = wildcards[1]
  Execute("exits")
end

function CheckExitsLine(name, line, wildcards)
  local exitname = string.gsub(wildcards.name, "%s+$", "")
--Note("trigger ["..exitname.."] target ["..target_exit.."]")
  if exitname == target_exit then
    Execute(wildcards.dir)
    target_exit = "!!!DONE!!!"
  end
end

function MazeTo(name, line, wildcards)
  target_maze_room  = wildcards[1]
  last_room = gmcp("room.info.num")
  solving_maze = true
  start_time = os.time()
  EnableTriggerGroup("mazeto", 1)
  Execute("#maze")
  DoMove()
end

function DoMove()
  Execute("#maze_next")
  SendNoEcho("echo {mazeto_moved}")
end

function MazeToMoved(msg, id, name, text)
  if solving_maze then
    local roomid = gmcp("room.info.num")
    if roomid == target_maze_room then
      Note("Arrived to target room "..tostring(target_maze_room))
      solving_maze = false
      EnableTriggerGroup("mazeto", 0)
      if not maze_to_no_resume_once then
        Execute("mapper resume")
      end
      maze_to_no_resume_once = false
    else
      Note("in room "..roomid.." continuing")
      DoMove()
    end
  end
end

function OnPluginBroadcast(msg, id, name, text)
  if solving_maze and (os.time() > start_time + timeout) then
    Note("Timed out going to target room "..tostring(target_maze_room))
    solving_maze = false
    EnableTriggerGroup("mazeto", 0)
  end
end

function OnPluginInstall()
   print("ExitTo loaded.")
   print(help_message)
end
]]>
</script>


</muclient>
